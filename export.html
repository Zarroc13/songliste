<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Songliste PDF-Export mit Songtexten & Inhaltsverzeichnis</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2rem auto; }
    h1 { text-align: center; }
    #export-pdf-btn { margin: 1rem 0; padding: 0.3rem 1.2rem; font-size: 1rem; }
    #status { margin: 1rem 0; }
    ul { line-height: 1.7; margin: 0; padding-left: 1.3em; }
  </style>
</head>
<body>
  <h1>Songliste PDF-Export (inkl. Songtexte & Inhaltsverzeichnis)</h1>
  <button id="export-pdf-btn" disabled>Exportiere alle Songs als PDF</button>
  <div id="status">Lade Songliste...</div>
  <div id="song-list"></div>
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-FcZH5479jScVw7EiJZSYs9awnAUWoMEpKqnl1F1CY5TpjIAM4okD2ZVYwz4HoyJS7RItGz7u7pFP/pub?output=csv";
    let allData = [];

    async function loadCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const result = Papa.parse(text, { header: true, skipEmptyLines: true });
      return result.data.map(obj => ({
        Datensatznummer: (obj["Datensatznummer"] || "").trim(),
        Song: (obj["Song"] || "").trim(),
        Interpret: (obj["Interpret"] || "").trim()
      })).filter(row => row.Song && row.Datensatznummer);
    }

    function renderList(list) {
      const container = document.getElementById("song-list");
      if (list.length === 0) {
        container.innerHTML = "<p>Keine Daten gefunden.</p>";
        return;
      }
      const ul = document.createElement("ul");
      list.forEach(row => {
        const li = document.createElement("li");
        li.textContent = `${row["Song"]} (${row["Interpret"]})`;
        ul.appendChild(li);
      });
      container.innerHTML = "";
      container.appendChild(ul);
    }

    async function fetchSongText(dsn) {
      try {
        const url = `songs/${dsn}.txt`;
        const res = await fetch(url);
        if (!res.ok) {
          console.warn("Fehler beim Laden:", url, res.status);
          return "[Kein Songtext gefunden]";
        }
        return await res.text();
      } catch (err) {
        console.error("Fehler beim Fetch:", err);
        return "[Fehler beim Laden des Songtexts]";
      }
    }

    function addSongInTwoColumns(doc, songTitle, songInterpret, songText, songAnchor) {
      // Zwei Spalten à 90mm (A4: 210mm - 2*15mm Rand = 180mm, also 2x90mm)
      const left = 15, top = 30, colWidth = 90, colHeight = 250;
      let fontSizeTitle = 14;
      let fontSizeInterpret = 11;
      let fontSizeText = 10;

      // Lesezeichen/Sprungziel (benötigt jsPDF >=2.5)
      doc.text(songTitle, left, top, {maxWidth: 180, link: songAnchor});
      doc.setFontSize(fontSizeTitle);
      doc.setFont("helvetica", "bold");
      doc.text(songTitle, left, top);
      doc.setFont("helvetica", "normal");
      doc.setFontSize(fontSizeInterpret);
      if(songInterpret) doc.text("Interpret: " + songInterpret, left, top+6);

      doc.setFontSize(fontSizeText);
      // Songtext umbrechen
      const lines = doc.splitTextToSize(songText, colWidth-2); // etwas Rand
      let curX = left, curY = top + 15, col = 0;
      for(let i=0; i<lines.length; i++) {
        if(curY > top + colHeight) {
          // Spalte wechseln oder Seite neu
          if(col === 0) { curX = left + colWidth; curY = top + 15; col = 1; }
          else { doc.addPage(); curX = left; curY = top + 15; col = 0; }
        }
        doc.text(lines[i], curX, curY);
        curY += 6;
      }
    }

    async function exportSongsAsPDF(songs) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
      let statusDiv = document.getElementById("status");
      statusDiv.textContent = "Erstelle PDF (das kann je nach Anzahl Songs etwas dauern)...";

      // 1. Inhaltsverzeichnis vorbereiten (Song-Titel merken)
      let toc = [];
      for (let i = 0; i < songs.length; i++) {
        toc.push({
          title: songs[i].Song,
          interpret: songs[i].Interpret,
          anchor: "song" + (i+1),
          page: 0 // Fügen wir später ein
        });
      }

      // 2. Inhaltsverzeichnis (Seite 1)
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("Inhaltsverzeichnis", 15, 20);
      doc.setFontSize(11);
      doc.setFont("helvetica", "normal");
      let y = 30;
      for(let i=0; i<toc.length; i++) {
        let entry = toc[i];
        // Platz für viele Songs: Spalte/n
        if(y > 270) { doc.addPage(); y = 20; }
        // Einfache interne Links (funktioniert in vielen PDF-Viewern, nicht allen!)
        doc.textWithLink(`${entry.title} (${entry.interpret})`, 20, y, {name: entry.anchor});
        y += 8;
      }

      // 3. Songs (ab Seite 2)
      for (let i = 0; i < songs.length; i++) {
        // Neue Seite für jeden Song (außer beim ersten, dann auf Inhaltsverzeichnis-Seite)
        if(i > 0) doc.addPage();

        statusDiv.textContent = `Lade Songtext für "${songs[i].Song}" (${i + 1}/${songs.length})...`;
        let text = await fetchSongText(songs[i].Datensatznummer);
        // Setze Lesezeichen/Ziel für Link
        doc.text("", 0, 0, {name: toc[i].anchor});
        addSongInTwoColumns(doc, songs[i].Song, songs[i].Interpret, text, toc[i].anchor);

        toc[i].page = doc.getCurrentPageInfo().pageNumber;
      }

      statusDiv.textContent = "Fertig! PDF wird heruntergeladen ...";
      doc.save("Songliste_mit_Texten.pdf");
      statusDiv.textContent = "Download abgeschlossen.";
    }

    // Initialisierung
    (async () => {
      allData = await loadCSV(csvUrl);
      document.getElementById("status").textContent = `${allData.length} Songs geladen.`;
      document.getElementById("export-pdf-btn").disabled = allData.length === 0;
      renderList(allData);
    })();

    document.getElementById("export-pdf-btn").addEventListener("click", async () => {
      document.getElementById("export-pdf-btn").disabled = true;
      await exportSongsAsPDF(allData);
      document.getElementById("export-pdf-btn").disabled = false;
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Songdetails</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0; padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #007acc;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    iframe {
      flex-grow: 1;
      width: 100%;
      border: none;
    }
    .message {
      padding: 2rem;
      text-align: center;
      font-size: 1.2rem;
      color: #444;
    }
  </style>
</head>
<body>
  <header id="songTitle">Lade Songdetails...</header>
  <div id="container">
    <div class="message">Wird geladen...</div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-FcZH5479jScVw7EiJZSYs9awnAUWoMEpKqnl1F1CY5TpjIAM4okD2ZVYwz4HoyJS7RItGz7u7pFP/pub?output=csv";

    async function loadCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows[0];
      return rows.slice(1).map(row => {
        const obj = Object.fromEntries(row.map((val, i) => [headers[i], val]));
        obj["Datensatznummer"] = obj["Datensatznummer"].trim(); // Als String!
        return obj;
      });
    }

    function showMessage(text) {
      const container = document.getElementById("container");
      container.innerHTML = `<div class="message">${text}</div>`;
    }

    if (!id) {
      showMessage("Keine ID angegeben.");
    } else {
      loadCSV(csvUrl).then(data => {
        const song = data.find(s => s["Datensatznummer"] === id);
        if (!song) {
          showMessage("Kein Song mit dieser ID gefunden.");
          return;
        }

        const title = song["Song"] || "Unbekannter Song";
        const docUrl = song["Noten"]?.trim();

        document.getElementById("songTitle").textContent = `${title} â€“ Akkorde & Text`;

        if (!docUrl) {
          showMessage("Kein eingebettetes Dokument vorhanden.");
        } else {
          const iframe = document.createElement("iframe");
          iframe.src = docUrl.includes("embedded=true") ? docUrl : docUrl + "?embedded=true";

          const container = document.getElementById("container");
          container.innerHTML = "";
          container.appendChild(iframe);
        }
      }).catch(err => {
        console.error(err);
        showMessage("Fehler beim Laden der Daten.");
      });
    }
  </script>
</body>
</html>

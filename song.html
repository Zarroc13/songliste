function computeScrollSpeed(val) {
  if (isMobile()) {
    return 0.1 + (val/100)*2.9;
  } else {
    return 0.1 + (val/100)*5.9;
  }
}

function startAutoscroll() {
  if (autoscrollActive) return;
  autoscrollActive = true;
  autoscrollBtn.textContent = "Autoscroll stoppen";
  autoscrollBtn.classList.add("active");

  function getDelayForLowSpeed(val) {
    if (val < 11) return 400 - (val - 1) * 40; // Stufe 1=400ms, 2=360ms, ..., 10=40ms, ab 11=0
    return 0;
  }

  function scrollStep() {
    if (!autoscrollActive) return;
    let usedSpeed = speedValue < 11 ? computeScrollSpeed(11) : computeScrollSpeed(speedValue);
    textEl.scrollTop += usedSpeed;
    if (textEl.scrollTop + textEl.clientHeight < textEl.scrollHeight) {
      let delay = getDelayForLowSpeed(speedValue);
      if (delay > 0) {
        autoscrollTimer = setTimeout(scrollStep, delay);
      } else {
        autoscrollTimer = requestAnimationFrame(scrollStep);
      }
    } else {
      stopAutoscroll();
    }
  }
  scrollStep();
}

function stopAutoscroll() {
  autoscrollActive = false;
  autoscrollBtn.textContent = "Autoscroll starten";
  autoscrollBtn.classList.remove("active");
  if (autoscrollTimer) {
    clearTimeout(autoscrollTimer);
    cancelAnimationFrame(autoscrollTimer);
  }
  autoscrollTimer = null;
}

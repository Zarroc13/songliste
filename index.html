<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Songliste PDF-Export mit Songtexten</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2rem auto; }
    h1 { text-align: center; }
    #export-pdf-btn { margin: 1rem 0; padding: 0.3rem 1.2rem; font-size: 1rem; }
    #status { margin: 1rem 0; }
  </style>
</head>
<body>
  <h1>Songliste PDF-Export (inkl. Texte)</h1>
  <button id="export-pdf-btn" disabled>Exportiere alle Songs als PDF</button>
  <div id="status">Lade Songliste...</div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-FcZH5479jScVw7EiJZSYs9awnAUWoMEpKqnl1F1CY5TpjIAM4okD2ZVYwz4HoyJS7RItGz7u7pFP/pub?output=csv";
    let allData = [];

    async function loadCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const result = Papa.parse(text, { header: true, skipEmptyLines: true });
      return result.data.map(obj => ({
        Datensatznummer: (obj["Datensatznummer"] || "").trim(),
        Song: (obj["Song"] || "").trim(),
        Interpret: (obj["Interpret"] || "").trim()
      })).filter(row => row.Song && row.Datensatznummer);
    }

    async function fetchSongText(dsn) {
      try {
        // Passe den Pfad ggf. an, Groß-/Kleinschreibung beachten!
        const res = await fetch(`Songs/${dsn}.txt`);
        if (!res.ok) return "[Kein Songtext gefunden]";
        return await res.text();
      } catch {
        return "[Fehler beim Laden des Songtexts]";
      }
    }

    async function exportSongsAsPDF(songs) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
      let statusDiv = document.getElementById("status");
      statusDiv.textContent = "Erstelle PDF (das kann je nach Anzahl Songs etwas dauern)...";

      for (let i = 0; i < songs.length; i++) {
        const song = songs[i];
        // Songtitel + Interpret
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text(song.Song, 12, 20);
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        if (song.Interpret)
          doc.text("Interpret: " + song.Interpret, 12, 28);

        // Songtext laden
        statusDiv.textContent = `Lade Songtext für "${song.Song}" (${i + 1}/${songs.length})...`;
        let text = await fetchSongText(song.Datensatznummer);

        // Text umbrechen für PDF
        let y = song.Interpret ? 38 : 32;
        const lines = doc.splitTextToSize(text, 180);
        doc.text(lines, 12, y);

        // Neue Seite, außer beim letzten Song
        if (i < songs.length - 1) doc.addPage();
      }

      statusDiv.textContent = "Fertig! PDF wird heruntergeladen ...";
      doc.save("Songliste_mit_Texten.pdf");
      statusDiv.textContent = "Download abgeschlossen.";
    }

    // Initialisierung
    (async () => {
      allData = await loadCSV(csvUrl);
      document.getElementById("status").textContent = `${allData.length} Songs geladen.`;
      document.getElementById("export-pdf-btn").disabled = allData.length === 0;
    })();

    document.getElementById("export-pdf-btn").addEventListener("click", async () => {
      document.getElementById("export-pdf-btn").disabled = true;
      await exportSongsAsPDF(allData);
      document.getElementById("export-pdf-btn").disabled = false;
    });
  </script>
</body>
</html>
